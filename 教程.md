# 一、GitHub 仓库核心文件（目标仓库：`project-x`）
需在 `project-x` 仓库根目录创建 **`LICENSE` 文件**（无后缀），内容为标准 MIT 协议模板（可直接复制使用，仅需替换 `[年份]` 和 `[版权持有者]`）：

```text
# MIT License

Copyright (c) [2025] [My Team / Your Name]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

### 仓库文件操作步骤（GitHub 网页端）
1. 登录 GitHub，创建名为 `project-x` 的仓库（归属你自己的账号或目标组织 `{{GITHUB_EVAL_ORG}}`）；
2. 仓库创建后，点击页面顶部 **Add file → Create new file**；
3. 文件名输入 `LICENSE`（无后缀，严格区分大小写），将上述 MIT 协议内容粘贴到编辑框，替换 `[2025]` 为实际年份（如 `2025`）、`[My Team / Your Name]` 为实际版权持有者（如 `Alice Dev Team`）；
4. 拉到页面底部，填写提交信息（如 `feat: add MIT LICENSE`），点击 **Commit new file**，确保提交到 `main` 分支（默认分支通常为 `main`，若不是需手动切换）。


# 二、本地环境核心文件
## 1. 环境变量文件（`.mcp_env`）
在本地创建一个文件夹（如 `github-license-verifier`），在该文件夹内新建 `.mcp_env` 文件，内容如下（需替换 `[你的GitHub令牌]` 和 `[你的GitHub组织/用户名]`）：

```ini
# .mcp_env（本地敏感配置文件，禁止提交到GitHub）
# 1. GitHub个人访问令牌（PAT）：需具备repo权限
MCP_GITHUB_TOKEN=[你的GitHub令牌]
# 2. 目标仓库所在的组织/用户名（如仓库地址是https://github.com/alice/project-x，则填alice）
GITHUB_EVAL_ORG=[你的GitHub组织/用户名]
```

### 生成 GitHub 令牌的详细步骤（确保权限正确）
1. 登录 GitHub，点击右上角头像 → **Settings**；
2. 左侧菜单拉到最底部，点击 **Developer settings** → **Personal access tokens** → **Generate new token**；
3. 填写 `Note`（如 `license-verifier-token`），勾选 **Expiration**（建议选 `No expiration`，避免频繁重生成）；
4. 权限勾选：展开 **repo** 选项，勾选其下所有子权限（`repo:status`、`repo_deployment`、`public_repo` 等，确保能读取仓库文件）；
5. 拉到页面底部，点击 **Generate token**，复制生成的令牌（仅显示一次，务必保存好，后续无法再次查看）；
6. 将复制的令牌替换 `.mcp_env` 中的 `[你的GitHub令牌]`，`[你的GitHub组织/用户名]` 替换为你创建 `project-x` 仓库的账号名（如 `alice`）。


## 2. 验证脚本文件（`GitHub_MIT_License_Verifier.py`）
在同一本地文件夹（`github-license-verifier`）内，新建 `GitHub_MIT_License_Verifier.py` 文件，内容如下（可直接复制使用，无需修改，已适配 `project-x` 仓库和 `main` 分支）：

```python
#!/usr/bin/env python3
# =============================================================================
# 实例：GitHub LICENSE 文件（MIT 协议）合规性验证脚本
# 功能：验证 "project-x" 仓库 main 分支中 LICENSE 文件是否存在，且内容符合 MIT 协议标准
# 依赖: requests, python-dotenv (安装：pip install requests python-dotenv)
# 使用说明：1. 配置 .mcp_env 文件；2. 安装依赖；3. 直接运行脚本
# =============================================================================

import sys
import os
import requests
import base64
from typing import Dict, Optional, Tuple
from dotenv import load_dotenv


# --------------------------
# 1. 通用工具函数（适配 LICENSE 验证场景）
# --------------------------
def _call_github_api(
    endpoint: str, 
    headers: Dict[str, str], 
    org: str, 
    repo: str = "project-x"  # 目标仓库名（与GitHub上创建的仓库一致）
) -> Tuple[bool, Optional[Dict]]:
    """调用 GitHub API 并返回（请求状态，响应数据）"""
    url = f"https://api.github.com/repos/{org}/{repo}/{endpoint}"
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            return True, response.json()
        elif response.status_code == 404:
            print(f"[API 提示] {endpoint} 资源未找到（404），可能是仓库/文件不存在或分支错误", file=sys.stderr)
            return False, None
        else:
            print(f"[API 错误] {endpoint} 状态码：{response.status_code}，可能是令牌权限不足", file=sys.stderr)
            return False, None
    except Exception as e:
        print(f"[API 异常] 调用 {endpoint} 失败：{str(e)}，请检查网络连接", file=sys.stderr)
        return False, None


def _get_license_content(
    headers: Dict[str, str],
    org: str,
    repo: str = "project-x",
    branch: str = "main"  # 与GitHub上LICENSE文件所在分支一致
) -> Optional[str]:
    """获取指定分支下 LICENSE 文件的内容（Base64 解码，UTF-8 编码）"""
    success, result = _call_github_api(
        f"contents/LICENSE?ref={branch}", headers, org, repo
    )
    if not success or not result:
        return None

    try:
        # 解码 Base64 内容，使用 UTF-8 编码（GitHub 文件默认编码）
        return base64.b64decode(result.get("content", "")).decode("utf-8")
    except Exception as e:
        print(f"[文件解码错误] LICENSE：{e}，可能是文件编码非 UTF-8", file=sys.stderr)
        return None


# --------------------------
# 2. 核心验证逻辑（MIT 协议专属校验）
# --------------------------
def verify_license_compliance() -> bool:
    """验证 LICENSE 文件存在性及 MIT 协议内容准确性"""
    # 1. 预期的 MIT 协议标准内容（清洁化后比对，允许空行/空格差异）
    EXPECTED_MIT_CONTENT = """MIT License
Copyright (c) [Year] [Copyright Holder]
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE."""
    
    # 2. 加载本地环境变量（从 .mcp_env 读取配置）
    load_dotenv(".mcp_env")  # 确保 .mcp_env 与脚本同级目录
    github_token = os.environ.get("MCP_GITHUB_TOKEN")
    github_org = os.environ.get("GITHUB_EVAL_ORG")

    # 3. 校验环境变量是否配置正确
    if not github_token:
        print("Error: .mcp_env 文件中未配置 MCP_GITHUB_TOKEN（GitHub 令牌）", file=sys.stderr)
        return False
    if not github_org:
        print("Error: .mcp_env 文件中未配置 GITHUB_EVAL_ORG（GitHub 组织/用户名）", file=sys.stderr)
        return False

    # 4. 构建 GitHub API 请求头（携带令牌认证）
    headers = {
        "Authorization": f"Bearer {github_token}",
        "Accept": "application/vnd.github.v3+json"  # 使用 GitHub API v3 版本（稳定版）
    }

    # 5. 执行验证流程
    print("=" * 60)
    print("开始执行 GitHub LICENSE 文件（MIT 协议）合规性验证")
    print(f"目标仓库：{github_org}/project-x（main 分支）")
    print("=" * 60)

    # 步骤1：验证 LICENSE 文件是否存在于 main 分支
    print("\n[1/2] 检查 main 分支中 LICENSE 文件是否存在...")
    license_content = _get_license_content(headers, github_org)
    if not license_content:
        print("Error: main 分支中未找到 LICENSE 文件（可能是路径、分支错误或令牌无权限）", file=sys.stderr)
        return False
    print("✓ 成功：LICENSE 文件存在于 main 分支")

    # 步骤2：验证 LICENSE 内容是否符合 MIT 协议标准（清洁化比对，排除空行/空格干扰）
    print("\n[2/2] 验证 LICENSE 内容是否符合 MIT 协议标准...")
    # 清洁化处理：移除空行、首尾空格，统一格式后比对
    def clean_content(content: str) -> str:
        lines = [line.strip() for line in content.splitlines() if line.strip()]
        return "\n".join(lines)
    
    cleaned_actual = clean_content(license_content)
    cleaned_expected = clean_content(EXPECTED_MIT_CONTENT)

    if cleaned_actual != cleaned_expected:
        print("Error: LICENSE 内容不符合 MIT 协议标准", file=sys.stderr)
        print("预期核心条款（示例）：Permission is hereby granted, free of charge...", file=sys.stderr)
        print("实际核心条款（示例）：" + cleaned_actual[:60] + "...", file=sys.stderr)
        return False
    print("✓ 成功：LICENSE 内容符合 MIT 协议标准")

    # 验证通过：输出总结
    print("\n" + "=" * 60)
    print("🎉 所有验证步骤通过！LICENSE 文件（MIT 协议）合规性校验成功")
    print("\n验证总结：")
    print(f"  - 目标仓库：{github_org}/project-x")
    print(f"  - 验证文件：LICENSE（main 分支，根目录）")
    print(f"  - 协议类型：MIT 开源协议")
    print(f"  - 版权信息：{[2025]} {[My Team / Your Name]}（与 LICENSE 文件中配置一致）")
    print("=" * 60)
    return True


# --------------------------
# 3. 脚本入口（直接运行）
# --------------------------
if __name__ == "__main__":
    success = verify_license_compliance()
    sys.exit(0 if success else 1)  # 成功返回0，失败返回1（适配CI/CD流程）
```


# 三、本地运行前的依赖安装
打开本地终端（Windows 用 cmd/PowerShell，macOS/Linux 用 Terminal），进入 `github-license-verifier` 文件夹（通过 `cd 文件夹路径` 命令，如 `cd D:\github-license-verifier`），执行以下命令安装依赖库：

```bash
pip install requests python-dotenv
```

### 验证依赖是否安装成功
执行以下命令，若不报错则说明依赖安装正常：
```bash
python -c "import requests; import dotenv; print('依赖安装成功')"
```


# 四、运行脚本并验证结果
在终端中，确保处于 `github-license-verifier` 文件夹下，执行以下命令运行脚本：

```bash
python GitHub_MIT_License_Verifier.py
```

### 预期成功输出
```
============================================================
开始执行 GitHub LICENSE 文件（MIT 协议）合规性验证
目标仓库：alice/project-x（main 分支）
============================================================

[1/2] 检查 main 分支中 LICENSE 文件是否存在...
✓ 成功：LICENSE 文件存在于 main 分支

[2/2] 验证 LICENSE 内容是否符合 MIT 协议标准...
✓ 成功：LICENSE 内容符合 MIT 协议标准

============================================================
🎉 所有验证步骤通过！LICENSE 文件（MIT 协议）合规性校验成功

验证总结：
  - 目标仓库：alice/project-x
  - 验证文件：LICENSE（main 分支，根目录）
  - 协议类型：MIT 开源协议
  - 版权信息：2025 Alice Dev Team（与 LICENSE 文件中配置一致）
============================================================
```

### 常见错误及解决方法
1. **“API 错误 404”**：检查 `project-x` 仓库是否存在、LICENSE 文件路径是否为根目录、分支是否为 `main`；
2. **“令牌权限不足”**：重新生成令牌，确保勾选 `repo` 下所有子权限；
3. **“环境变量未配置”**：检查 `.mcp_env` 文件名是否正确（无后缀，不是 `.mcp_env.txt`）、变量名是否拼写错误（`MCP_GITHUB_TOKEN`/`GITHUB_EVAL_ORG`）。


# 五、本地安全配置（可选但推荐）
在 `github-license-verifier` 文件夹内新建 `.gitignore` 文件，添加以下内容，防止 `.mcp_env` 敏感文件被误提交到 GitHub：

```text
# .gitignore（本地仓库忽略文件）
.mcp_env
__pycache__/
*.pyc
*.pyo
*.pyd
```
